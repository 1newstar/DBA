# DTS同步增量测试

[TOC]

## 测试背景

1. rds数据迁移

2. 迁移前源rds有一个备库，通过dts同步完成

3. 源rds迁移到目标rds后，是否可以直接使用dts同步增量新建同步，完成目标rds和备份rds的数据同步呢？

   ​

## 测试实例

| RDS  | 角色   | id                   |
| ---- | ---- | -------------------- |
| 1    | 源主库  | rm-bp1qk48206sgxln03 |
| 2    | 备库   | rm-bp1s29n733x30e5n6 |
| 3    | 目标主库 | rm-uf62g448h7zj456ia |

![](pic/11.png)

![](pic/12.png)



## 测试场景1——备份实例备份所有数据

### 1. 搭建源实例与备份实例的同步1




```shell
mysql>CREATE TABLE t1(   
id int primary key auto_increment,    
uname  varchar(20) ,   
ucreatetime  datetime  ,   
age  int(11)) DEFAULT CHARACTER SET=utf8 COLLATE=utf8_general_ci;
执行成功,花费 5 ms.
mysql>delimiter $$
sql分隔符设置为[$$]
mysql>create  procedure test1()  
begin

declare v_cnt decimal (10)  default 0 ;
start transaction;
dd:loop            
        insert  into t1 values         
        (null,'用户1','2010-01-01 00:00:00',20),         
        (null,'用户2','2010-01-01 00:00:00',20),         
        (null,'用户3','2010-01-01 00:00:00',20),         
        (null,'用户4','2010-01-01 00:00:00',20),         
        (null,'用户5','2011-01-01 00:00:00',20),         
        (null,'用户6','2011-01-01 00:00:00',20),         
        (null,'用户7','2011-01-01 00:00:00',20),         
        (null,'用户8','2012-01-01 00:00:00',20),         
        (null,'用户9','2012-01-01 00:00:00',20),         
        (null,'用户0','2012-01-01 00:00:00',20)             
                ;                                        
        set v_cnt = v_cnt+10 ;                            
            if  v_cnt = 10000000 then leave dd;                           
            end if;          
        end loop dd ; 
commit;
end;
执行成功,花费 3 ms.
mysql>delimiter ;
sql分隔符设置为[;]
mysql>call test1();
执行成功,花费 62974 ms.

mysql>insert into t1 values (null,'booboo',sysdate(),100);
共影响 1 行记录,花费 5 ms.
mysql>insert into t1 values (null,'superman',sysdate(),200);
共影响 1 行记录,花费 4 ms.
mysql>insert into t1 values (null,'batman',sysdate(),300);
共影响 1 行记录,花费 4 ms.
```

![](pic/21.png)

![](pic/22.png)

![](pic/23.png)

```shell
# 从库上可以查看同步过来的数据
mysql>select * from t1 where id=10000001;
+--------------+-----------------+-----------------------+---------------+
| id           | uname           | ucreatetime           | age           |
+--------------+-----------------+-----------------------+---------------+
|     10000001 | booboo          | 2017-07-25 11:59:08   |           100 |
+--------------+-----------------+-----------------------+---------------+
共返回 1 行记录,花费 3 ms.
mysql>select * from t1 where id=10000004;
+--------------+-----------------+-----------------------+---------------+
| id           | uname           | ucreatetime           | age           |
+--------------+-----------------+-----------------------+---------------+
|     10000004 | 主备同步后插入  | 2017-07-25 12:25:57   |           300 |
+--------------+-----------------+-----------------------+---------------+
共返回 1 行记录,花费 3 ms.
```

### 2. 搭建源实例与目标实例的同步2

![](pic/24.png)
![](pic/25.png)
![](pic/26.png)

```shell
# 源实例
mysql>insert into t1 values (null,'目标库同步后插入',sysdate(),400);
共影响 1 行记录,花费 4 ms.

# 目标实例
mysql>SELECT * FROM t1 where id=10000004;
+--------------+-----------------+-----------------------+---------------+
| id           | uname           | ucreatetime           | age           |
+--------------+-----------------+-----------------------+---------------+
|     10000004 | 主备同步后插入  | 2017-07-25 12:25:57   |           300 |
+--------------+-----------------+-----------------------+---------------+
共返回 1 行记录,花费 2 ms.
mysql>SELECT * FROM t1 where id=10000005;
+--------------+------------------+-----------------------+---------------+
| id           | uname            | ucreatetime           | age           |
+--------------+------------------+-----------------------+---------------+
|     10000005 | 目标库同步后插入 | 2017-07-25 12:50:21   |           400 |
+--------------+------------------+-----------------------+---------------+
共返回 1 行记录,花费 2 ms.
```
### 3. 停止对源实例的写入，暂停并释放同步2（源实例-目标实例）




### 4. 暂停并释放同步1（源实例-备份实例）

由于跨区域，无法修改dts同步中的源实例
![](pic/27.png)
![](pic/28.png)

![](pic/29.png)


### 5. 新建同步3（目标实例-备份实例）


![](pic/30.png)
![](pic/31.png)
![](pic/32.png)
![](pic/33.png)
![](pic/34.png)



```shell
# 目标实例
mysql>insert into t1 values (null,'目标实例和备份实例同步后',sysdate(),100);
共影响 1 行记录,花费 5 ms.
# 备份实例
mysql>select * from t1 where id>10000000;
+--------------+--------------------------+-----------------------+---------------+
| id           | uname                    | ucreatetime           | age           |
+--------------+--------------------------+-----------------------+---------------+
|     10000001 | booboo                   | 2017-07-25 11:59:08   |           100 |
|     10000002 | superman                 | 2017-07-25 12:03:23   |           200 |
|     10000003 | batman                   | 2017-07-25 12:03:52   |           300 |
|     10000004 | 主备同步后插入           | 2017-07-25 12:25:57   |           300 |
|     10000005 | 目标库同步后插入         | 2017-07-25 12:50:21   |           400 |
|     10000006 | 目标实例和备份实例同步后 | 2017-07-25 13:11:15   |           100 |
+--------------+--------------------------+-----------------------+---------------+
共返回 6 行记录,花费 3 ms.
```



---

## 测试场景2——备份实例只备份某些表

> 备份实例只备份某些表

![](pic/41.png)



备份实例同步内容：
![](pic/43.png)



目标实例同步所有数据：

![](pic/44.png)



```shell
# 源实例
# database：booboo（t1,t2,t3）
# database：justice(superman,batman)
mysql>create table t2 (id int primary key auto_increment,name varchar(30),time timestamp);
执行成功,花费 5 ms.
mysql>create table t3 (id int primary key auto_increment,name varchar(30),time timestamp);
执行成功,花费 5 ms.
mysql>insert into t2 set name='t2';
共影响 1 行记录,花费 4 ms.
mysql>insert into t3 set name='t3';
共影响 1 行记录,花费 5 ms.
mysql>select * from t2;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t2             | 2017-07-25 13:39:23 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 2 ms.
mysql>select * from t3;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t3             | 2017-07-25 13:39:24 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 2 ms.
mysql>show tables;
+----------------------------+
| Tables_in_booboo           |
+----------------------------+
| t1                         |
| t2                         |
| t3                         |
+----------------------------+
共返回 3 行记录,花费 2 ms.


mysql>create table superman (id int primary key auto_increment,name varchar(30),time timestamp);
执行成功,花费 5 ms.
mysql>create table batman (id int primary key auto_increment,name varchar(30),time timestamp);
执行成功,花费 5 ms.
mysql>insert into superman set name='superman';
共影响 1 行记录,花费 4 ms.
mysql>insert into batman set name='batman';
共影响 1 行记录,花费 4 ms.
mysql>select * from batman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | batman         | 2017-07-25 13:43:02 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 1 ms.
mysql>select * from superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 2 ms.
mysql>show tables;
+-----------------------------+
| Tables_in_justice           |
+-----------------------------+
| batman                      |
| superman                    |
+-----------------------------+
共返回 2 行记录,花费 2 ms.


#备份实例只备份
# booboo.t2
# justice.superman

mysql>select * from t2;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t2             | 2017-07-25 13:39:23 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 3 ms.
mysql>SELECT * FROM superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 3 ms.




# 目标实例同步all
# justice
mysql>SELECT * FROM batman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | batman         | 2017-07-25 13:43:02 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 2 ms.
mysql>select * from superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 1 ms.
# booboo
mysql>select * from t1 where id>10000000;
+--------------+------------------+-----------------------+---------------+
| id           | uname            | ucreatetime           | age           |
+--------------+------------------+-----------------------+---------------+
|     10000001 | booboo           | 2017-07-25 11:59:08   |           100 |
|     10000002 | superman         | 2017-07-25 12:03:23   |           200 |
|     10000003 | batman           | 2017-07-25 12:03:52   |           300 |
|     10000004 | 主备同步后插入   | 2017-07-25 12:25:57   |           300 |
|     10000005 | 目标库同步后插入 | 2017-07-25 12:50:21   |           400 |
+--------------+------------------+-----------------------+---------------+
共返回 5 行记录,花费 3 ms.
mysql>select * from t2;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t2             | 2017-07-25 13:39:23 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 2 ms.
mysql>select * from t3;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t3             | 2017-07-25 13:39:24 |
+--------------+----------------+---------------------+
共返回 1 行记录,花费 2 ms.

-------------------------------
1.停止对原实例的写操作
2.释放同步1
3.释放同步2
4.新建同步3

-------------------------------
# 目标实例
# booboo
mysql>insert into t2 set name='test';
共影响 1 行记录,花费 6 ms.
mysql>select * from t2;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t2             | 2017-07-25 13:39:23 |
|            2 | test           | 2017-07-25 14:13:15 |
+--------------+----------------+---------------------+
共返回 2 行记录,花费 1 ms.
# justice
mysql>insert into superman set name='wonderwoman';
共影响 1 行记录,花费 5 ms.
mysql>select * from superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
|            2 | wonderwoman    | 2017-07-25 14:15:40 |
+--------------+----------------+---------------------+
共返回 2 行记录,花费 2 ms.


# 备份实例
# test
mysql>select * from t2;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | t2             | 2017-07-25 13:39:23 |
|            2 | test           | 2017-07-25 14:13:15 |
+--------------+----------------+---------------------+
共返回 2 行记录,花费 3 ms.
# justice
mysql>SELECT * FROM superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
|            2 | wonderwoman    | 2017-07-25 14:15:40 |
+--------------+----------------+---------------------+
共返回 2 行记录,花费 3 ms.
```

## 测试场景3——同步增量的开始位置



```shell
1. 释放同步3
2. 在数据一致的前提下，先在目标实例进行写操作
# 目标实例
mysql>insert into superman set name='supergirl';
共影响 1 行记录,花费 4 ms.
mysql>select * from superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
|            2 | wonderwoman    | 2017-07-25 14:15:40 |
|            3 | supergirl      | 2017-07-25 14:24:55 |
+--------------+----------------+---------------------+
共返回 3 行记录,花费 2 ms.

3. 创建新的增量同步3
4. 查看备份实例的数据

# 目标实例
mysql>insert into superman set name='last';
共影响 1 行记录,花费 5 ms.
mysql>select * from superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
|            2 | wonderwoman    | 2017-07-25 14:15:40 |
|            3 | supergirl      | 2017-07-25 14:24:55 |
|            4 | last           | 2017-07-25 14:29:10 |
+--------------+----------------+---------------------+
共返回 4 行记录,花费 2 ms.

# 备份实例
mysql>SELECT * FROM superman;
+--------------+----------------+---------------------+
| id           | name           | time                |
+--------------+----------------+---------------------+
|            1 | superman       | 2017-07-25 13:42:50 |
|            2 | wonderwoman    | 2017-07-25 14:15:40 |
|            4 | last           | 2017-07-25 14:29:10 |
+--------------+----------------+---------------------+
共返回 3 行记录,花费 3 ms.
```

可以看到丢失了id=3的数据，因此要求在迁移过程中，必须严格按照一下流程来走：

1. 待源实例-目标实例的同步任务达到无延迟状态，则停止对源实例的写操作

2. 释放源实例-目标实例的同步任务

3. 释放源实例-备份实例的同步任务

4. 新建目标实例-备份实例的同步任务

5. 切换应用到目标实例

   ​